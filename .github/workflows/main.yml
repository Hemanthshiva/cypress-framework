name: Cypress Tests using Cypress Docker Image

on: push

jobs:
  install:
    runs-on: ubuntu-latest
    container:
      image: cypress/browsers:node-20.14.0-chrome-125.0.6422.141-1-ff-126.0.1-edge-125.0.2535.85-1
      options: --user 1001
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cypress install
        uses: cypress-io/github-action@v6.5.0
        with:
          runTests: false
      # report machine parameters
      - run: yarn cypress info
      - run: node --version
      - run: node -p 'os.cpus()'

  ui-chrome-tests:
    timeout-minutes: 15
    runs-on: ubuntu-latest
    container:
      image: cypress/browsers:node-20.14.0-chrome-125.0.6422.141-1-ff-126.0.1-edge-125.0.2535.85-1
      options: --user 1001
    needs: install
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2, 3]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Node info
        run: node -v

      - name: 'UI Tests - Chrome'
        id: test
        uses: cypress-io/github-action@v6.5.0
        with:
          build: yarn cypress info
          browser: chrome
          record: true
          parallel: true
          group: 'UI - Chrome'
          spec: cypress/e2e/cucumber-tests/featureFiles/*
          config-file: cypress.config.ts
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Sleep for 30 seconds
        run: sleep 30s
        shell: bash
      
      - name: 'Upload report'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          # name: cypress-report-${{ matrix.containers }}
          path: cypress/cucumber-json/

  merge-reports:
    needs: ui-chrome-tests
    if: success() || failure()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

         # Ensure the directory exists before running the merge
      - name: Ensure Report Directory Exists
        run: mkdir -p cypress/json-reports

      - name: Download reports from all containers
        uses: actions/download-artifact@v4
        with:
          path: cypress/json-reports
          
      - name: List Files
        run: ls -R
     
      # - name: Upload merged report
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: merged-cypress-report
      #     path: cypress/json-reports/

  # deploy-reports:
  #   needs: [merge-reports]
  #   if: always()
  #   runs-on: ubuntu-latest

  #   permissions:
  #     id-token: write
  #     pages: write

  #   steps:
  #     - name: Download merged report
  #       uses: aochmann/actions-download-artifact@1.0.4
  #       with:
  #         name: merged-cypress-report
  #         path: cypress/cucumber-report/
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
  #     - name: Setup Github report page
  #       uses: actions/configure-pages@v5.0.0
      
  #     - name: Upload artifact
  #       uses: actions/upload-pages-artifact@v3.0.1
  #       with:
  #         path: cypress/cucumber-report/
      
  #     - name: Deploy to Github Pages
  #       id: deployment
  #       uses: actions/deploy-pages@v4.0.5
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
