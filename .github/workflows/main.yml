name: Cypress Tests using Cypress Docker Image

on: push

jobs:
  install:
    runs-on: ubuntu-latest
    container:
      image: cypress/browsers:node-20.14.0-chrome-125.0.6422.141-1-ff-126.0.1-edge-125.0.2535.85-1
      options: --user 1001
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cypress install
        uses: cypress-io/github-action@v6.5.0
        with:
          runTests: false
      # report machine parameters
      - run: yarn cypress info
      - run: node --version
      - run: node -p 'os.cpus()'

  ui-chrome-tests:
    timeout-minutes: 15
    runs-on: ubuntu-latest
    container:
      image: cypress/browsers:node-20.14.0-chrome-125.0.6422.141-1-ff-126.0.1-edge-125.0.2535.85-1
      options: --user 1001
    needs: install
    strategy:
      fail-fast: false
      matrix:
        containers: [1, 2, 3]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Node info
        run: node -v

      - name: 'UI Tests - Chrome'
        id: test
        uses: cypress-io/github-action@v6.5.0
        with:
          build: yarn cypress info
          browser: chrome
          record: true
          parallel: true
          group: 'UI - Chrome'
          spec: cypress/e2e/cucumber-tests/featureFiles/*
          config-file: cypress.config.ts
        env:
          CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Sleep for 30 seconds
        run: sleep 30s
        shell: bash
      
      - name: 'Generate report'
        if: success() || failure()
        run: yarn cy:report

      - name: 'Upload report'
        if: always()
        uses: echapmanFromBunnings/upload-artifact@3.0.0
        with:
          name: cypress-report-${{ matrix.containers }}
          path: cypress/cucumber-html-report

  merge-reports:
    needs: ui-chrome-tests
    if: success() || failure()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download reports from all containers
        uses: aochmann/actions-download-artifact@1.0.4
        with:
          name: cypress-report-*
          path: cypress/cucumber-html-report/
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # Ensure the directory exists before running the merge
      - name: Ensure Report Directory Exists
        run: mkdir -p cypress/merged-report

      # Here you can add a custom script to merge the reports
      - name: Merge Cucumber Reports
        run: |
          yarn merge-cucumber-reports -i cypress/cucumber-html-report -o cypress/merged-report/cucumber-report.json

      - name: Check if the merged report was generated
        run: |
          if [ -f cypress/merged-report/cucumber-report.json ]; then
            echo "Merged report exists."
          else
            echo "Merged report not found!"
            exit 1
          fi

      - name: Upload merged report
        uses: echapmanFromBunnings/upload-artifact@3.0.0
        with:
          name: merged-cypress-report
          path: cypress/merged-report/

  deploy-reports:
    needs: [merge-reports]
    if: always()
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      pages: write

    steps:
      - name: Download merged report
        uses: aochmann/actions-download-artifact@1.0.4
        with:
          name: merged-cypress-report
          path: cypress/merged-report/
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Github report page
        uses: actions/configure-pages@v5.0.0
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3.0.1
        with:
          path: cypress/merged-report/
      
      - name: Deploy to Github Pages
        id: deployment
        uses: actions/deploy-pages@v4.0.5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
